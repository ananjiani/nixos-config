---
date: 2026-01-26
title: Buildbot deploy-rs checks building redundant derivations
severity: minor
duration: N/A (efficiency issue, not outage)
systems: [buildbot-nix, deploy-rs, attic]
tags: [ci, nix, caching]
commit: https://codeberg.org/ananjiani/infra/commit/ff8aa4d
status: unverified
---

## Summary

The `deploy-schema` and `deploy-activate` checks generated by deploy-rs were both building the same server NixOS system derivations, potentially doubling CI compute time. Added explicit server system checks to populate the cache before deploy checks run.

## Timeline

All times CST.

- **~13:00** - Noticed buildbot deploy-schema and deploy-activate appeared to have overlapping builds
- **~13:15** - Investigated deploy-rs `deployChecks` function behavior
- **~13:30** - Confirmed both checks depend on building `activatable-nixos-system-*` derivations for all 4 servers
- **~13:45** - Identified that parallel execution prevents cache reuse between the two checks
- **~14:00** - Implemented fix: added explicit `nixos-{boromir,samwise,theoden,pippin}` checks
- **~14:05** - Pushed change, buildbot evaluated successfully
- **~14:10** - All checks skipped (already cached) - fix unverified

## What Happened

The `deploy-rs.lib.deployChecks` function generates two checks:

1. `deploy-schema` - validates JSON schema of deploy configuration
2. `deploy-activate` - validates activation scripts exist and are valid

Both checks need to evaluate and build the full NixOS system derivations for each deploy target (boromir, pippin, samwise, theoden). When buildbot runs checks in parallel, both start building simultaneously before either can benefit from the other's cached results.

The Attic binary cache at `theoden.lan:8080` should help, but only if builds are sequential - Build A finishes and pushes to cache, then Build B finds cached results. With parallel execution, both builds race and duplicate work.

## Contributing Factors

- `deployChecks` generates two separate checks that share heavy dependencies
- Buildbot-nix runs all checks in parallel by default
- The `deploy-schema` check builds full systems just to generate and validate a JSON file
- No explicit server system checks existed to "warm" the cache

## What I Was Wrong About

- **Assumed Attic cache would prevent redundant builds** - Cache only helps with sequential builds, not parallel ones racing to build the same derivations
- **Assumed deploy-schema was lightweight** - It actually needs to build the full system to generate the deploy.json it validates

## What Helped

- `nix build` output showing which derivations were being built revealed the overlap
- Buildbot API allowed inspecting what was built vs skipped

## What Could Have Been Worse

- With more deploy targets, the wasted compute would scale linearly
- If builds weren't already cached from development, every CI run would double-build

## Is This a Pattern?

- [x] Pattern: Revisit the approach

Any flake checks that share expensive dependencies and run in parallel may have this issue. Consider whether checks with shared dependencies should be consolidated or have explicit "cache warming" checks.

## Action Items

- [ ] **Verify fix works**: Wait for a server config change and confirm deploy checks use cached systems
- [ ] Update this postmortem with verification results
- [ ] Consider removing `deploy-schema` entirely (low value, high cost)

## Lessons

- **Parallel CI checks can defeat caching** - If two checks need the same derivation, the first to finish wins, but if they start together, both build
- **deploy-rs deployChecks is expensive** - Both checks build full systems, not just validate metadata
- **Explicit "cache warming" checks help** - Building systems as separate checks ensures they're cached before dependent checks run
- **Attic/substituters only help sequential builds** - Can't substitute a derivation that's currently being built elsewhere

## Verification Needed

This fix is **unverified**. The first CI run after the change found everything already cached, so we couldn't confirm the optimization works. Update this postmortem when:

1. A server config changes
2. The explicit `nixos-*` check builds it
3. The `deploy-activate` check shows cache hits for that system
