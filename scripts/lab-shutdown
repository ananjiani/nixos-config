#!/usr/bin/env bash
set -euo pipefail

# Selective homelab shutdown with dependency resolution
# Run from devshell (nix develop) for kubectl access

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# shellcheck source=lab-common.sh
source "$SCRIPT_DIR/lab-common.sh"

show_help() {
  cat <<'USAGE'
Usage: lab-shutdown [options] [targets...]

Gracefully shuts down selected homelab nodes. Automatically drains
k3s nodes and resolves dependencies (Proxmox host â†’ its VMs).

USAGE
  show_common_options
  echo ""
  show_topology
  cat <<'EXAMPLES'

Examples:
  lab-shutdown rohan              Drain theoden, shut down theoden + rohan
  lab-shutdown --k3s              Drain & shut down all k3s nodes
  lab-shutdown the-shire          Drain samwise, shut down samwise + pippin + frodo + the-shire
  lab-shutdown pippin             Shut down just pippin
  lab-shutdown --all              Full homelab shutdown
  lab-shutdown --dry-run --all    Preview full shutdown plan
EXAMPLES
}

parse_args "$@"
resolve_shutdown_deps
classify_targets

# --- Pre-flight ---
if [[ ${#TARGET_K3S[@]} -gt 0 ]]; then
  if ! command -v kubectl &>/dev/null; then
    error "kubectl not found. Are you in the devshell? (nix develop)"
    exit 1
  fi
  if ! $DRY_RUN && ! kubectl get nodes &>/dev/null; then
    error "Cannot reach k3s cluster. Check KUBECONFIG and network."
    exit 1
  fi
fi

# --- Show plan ---
echo ""
echo "Shutdown plan:"
[[ ${#TARGET_K3S[@]} -gt 0 ]]     && echo "  Drain k3s:       ${TARGET_K3S[*]}"
[[ ${#TARGET_VMS_SSH[@]} -gt 0 ]] && echo "  Shutdown (SSH):   ${TARGET_VMS_SSH[*]}"
[[ ${#TARGET_VMS_QM[@]} -gt 0 ]]  && echo "  Shutdown (ACPI):  ${TARGET_VMS_QM[*]}"
[[ ${#TARGET_BARE[@]} -gt 0 ]]    && echo "  Shutdown (bare):  ${TARGET_BARE[*]}"
[[ ${#TARGET_PROXMOX[@]} -gt 0 ]] && echo "  Shutdown Proxmox: ${TARGET_PROXMOX[*]}"
echo ""

if ! $DRY_RUN; then
  confirm
fi

# --- Phase 0: Disconnect local Tailscale ---
# Prevents losing network when Headscale/DNS on the cluster goes down
if command -v tailscale &>/dev/null && tailscale status &>/dev/null; then
  step "Disconnecting local Tailscale..."
  run_or_dry tailscale down
fi

# --- Phase 1: Drain k3s nodes ---
if [[ ${#TARGET_K3S[@]} -gt 0 ]]; then
  step "Draining k3s nodes..."
  for node in "${K3S_DRAIN_ORDER[@]}"; do
    if is_in_array "$node" "${TARGET_K3S[@]}"; then
      info "Cordoning $node"
      run_or_dry kubectl cordon "$node"
    fi
  done
  for node in "${K3S_DRAIN_ORDER[@]}"; do
    if is_in_array "$node" "${TARGET_K3S[@]}"; then
      info "Draining $node"
      run_or_dry kubectl drain "$node" \
        --ignore-daemonsets --delete-emptydir-data --disable-eviction --timeout=120s || {
        warn "Drain timed out for $node, continuing..."
      }
    fi
  done
fi

# --- Phase 2: Shut down VMs via SSH ---
if [[ ${#TARGET_VMS_SSH[@]} -gt 0 ]]; then
  step "Shutting down VMs (SSH)..."
  for vm in "${TARGET_VMS_SSH[@]}"; do
    info "Shutting down $vm"
    run_or_dry ssh -o ConnectTimeout=5 "root@${vm}" "shutdown now" 2>/dev/null || true
  done
fi

# --- Phase 3: Shut down VMs via qm (no SSH, e.g. frodo) ---
if [[ ${#TARGET_VMS_QM[@]} -gt 0 ]]; then
  step "Shutting down VMs (ACPI)..."
  for vm in "${TARGET_VMS_QM[@]}"; do
    local_host="${VM_HOST[$vm]}"
    local_vmid="${VM_ID[$vm]}"
    info "Shutting down $vm (qm shutdown $local_vmid on $local_host)"
    run_or_dry ssh -o ConnectTimeout=5 "root@${local_host}" "qm shutdown $local_vmid --timeout 60" || {
      warn "ACPI shutdown failed for $vm, trying hard stop..."
      run_or_dry ssh -o ConnectTimeout=5 "root@${local_host}" "qm stop $local_vmid" || true
    }
  done
fi

# --- Phase 4: Shut down bare metal ---
if [[ ${#TARGET_BARE[@]} -gt 0 ]]; then
  step "Shutting down bare metal..."
  for bm in "${TARGET_BARE[@]}"; do
    info "Shutting down $bm"
    run_or_dry ssh -o ConnectTimeout=5 "root@${bm}" "shutdown now" 2>/dev/null || true
  done
fi

# --- Phase 5: Wait ---
if [[ ${#TARGET_VMS_SSH[@]} -gt 0 || ${#TARGET_VMS_QM[@]} -gt 0 || ${#TARGET_BARE[@]} -gt 0 ]]; then
  if ! $DRY_RUN; then
    info "Waiting 30s for systems to fully shut down..."
    sleep 30
  fi
fi

# --- Phase 6: Shut down Proxmox hosts ---
if [[ ${#TARGET_PROXMOX[@]} -gt 0 ]]; then
  step "Shutting down Proxmox hosts..."
  for px in "${TARGET_PROXMOX[@]}"; do
    info "Shutting down $px"
    run_or_dry ssh -o ConnectTimeout=5 "root@${px}" "shutdown now" 2>/dev/null || true
  done
fi

echo ""
info "Shutdown sequence complete."
