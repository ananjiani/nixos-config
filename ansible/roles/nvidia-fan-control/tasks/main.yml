---
# Kernel 6.17 has no headers yet - use 6.14 which works with nvidia 550.x
- name: Install Proxmox kernel 6.14 with headers
  ansible.builtin.apt:
    name:
      - proxmox-kernel-6.14
      - proxmox-headers-6.14
    state: present

- name: Pin Proxmox kernel to 6.14 (prevent nvidia breakage on kernel update)
  ansible.builtin.copy:
    dest: /etc/apt/preferences.d/proxmox-kernel
    content: |
      # Pin to kernel 6.14 for NVIDIA driver compatibility
      Package: proxmox-kernel-6.17* proxmox-kernel-6.18*
      Pin: version *
      Pin-Priority: -1
    mode: '0644'

- name: Get installed 6.14 kernel version
  ansible.builtin.shell: ls /boot/vmlinuz-6.14* | head -1 | sed 's|/boot/vmlinuz-||'
  register: kernel_6_14_version
  changed_when: false

- name: Set kernel 6.14 as default boot kernel
  ansible.builtin.command:
    cmd: proxmox-boot-tool kernel pin {{ kernel_6_14_version.stdout }}
  register: kernel_pin_result
  changed_when: "'Setting' in kernel_pin_result.stdout"

- name: Refresh boot configuration
  ansible.builtin.command:
    cmd: proxmox-boot-tool refresh
  when: kernel_pin_result.changed

- name: Check current kernel version
  ansible.builtin.command: uname -r
  register: current_kernel
  changed_when: false

- name: Notify if reboot needed for kernel 6.14
  ansible.builtin.debug:
    msg: "WARNING: Reboot into kernel 6.14 required! Current kernel: {{ current_kernel.stdout }}. Run 'reboot' then re-run this playbook."
  when: "'6.14' not in current_kernel.stdout"

- name: Fail if not running kernel 6.14
  ansible.builtin.fail:
    msg: "Must reboot into kernel 6.14 before NVIDIA driver can be built. Run 'reboot' and re-run playbook."
  when: "'6.14' not in current_kernel.stdout"

- name: Add Debian non-free repository
  ansible.builtin.apt_repository:
    repo: "deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware"
    state: present
    filename: non-free
    update_cache: false

- name: Install NVIDIA driver and fan control dependencies
  ansible.builtin.apt:
    name:
      - nvidia-driver
      - nvidia-smi
      - nvidia-settings
      - xserver-xorg
      - python3-pip
    state: present
    update_cache: true

- name: Rebuild NVIDIA DKMS module
  ansible.builtin.command:
    cmd: dkms autoinstall
  register: dkms_result
  changed_when: "'Building' in dkms_result.stdout"

- name: Update module dependencies
  ansible.builtin.command:
    cmd: depmod -a
  changed_when: false

- name: Configure NVIDIA modules to load at boot
  ansible.builtin.copy:
    dest: /etc/modules-load.d/nvidia.conf
    content: |
      # NVIDIA modules - loaded at boot for GPU support
      nvidia-current
      nvidia-current-modeset
      nvidia-current-drm
      nvidia-current-uvm
    mode: '0644'

- name: Load NVIDIA modules now
  ansible.builtin.shell: |
    modprobe nvidia-current
    modprobe nvidia-current-modeset
    modprobe nvidia-current-drm
    modprobe nvidia-current-uvm
  changed_when: false

- name: Enable nvidia-persistenced
  ansible.builtin.systemd:
    name: nvidia-persistenced
    enabled: true
    state: started

- name: Install pipx for Python app isolation
  ansible.builtin.apt:
    name: pipx
    state: present

- name: Install coolgpus for headless fan control
  ansible.builtin.command:
    cmd: pipx install coolgpus
    creates: /root/.local/bin/coolgpus
  environment:
    PIPX_HOME: /opt/pipx
    PIPX_BIN_DIR: /usr/local/bin

- name: Create coolgpus systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/coolgpus.service
    content: |
      [Unit]
      Description=NVIDIA GPU Fan Control (coolgpus)
      After=nvidia-persistenced.service

      [Service]
      Type=simple
      # Fan curve: 25% at 40C, 35% at 50C, 50% at 60C, 70% at 70C, 100% at 80C
      ExecStart=/usr/local/bin/coolgpus --temp 40 50 60 70 80 --speed 25 35 50 70 100
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  notify: Restart coolgpus

- name: Enable and start coolgpus
  ansible.builtin.systemd:
    name: coolgpus
    enabled: true
    state: started
    daemon_reload: true
