---
# Disable enterprise repos (require subscription)
- name: Disable Proxmox enterprise repository
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/pve-enterprise.list
    state: absent

- name: Disable Ceph enterprise repository
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/ceph.list
    state: absent

# Add no-subscription repos
- name: Add Proxmox no-subscription repository
  ansible.builtin.apt_repository:
    repo: "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
    state: present
    filename: pve-no-subscription
    update_cache: false

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Install base packages
  ansible.builtin.apt:
    name: "{{ proxmox_base_packages }}"
    state: present

- name: Configure SSH - PermitRootLogin
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: "PermitRootLogin {{ ssh_permit_root_login }}"
  notify: Restart SSH

- name: Configure SSH - PasswordAuthentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: "PasswordAuthentication {{ ssh_password_authentication }}"
  notify: Restart SSH

- name: Configure SSH - PubkeyAuthentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PubkeyAuthentication'
    line: "PubkeyAuthentication {{ ssh_pubkey_authentication }}"
  notify: Restart SSH

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    mode: '0700'

- name: Deploy SSH authorized keys
  ansible.builtin.lineinfile:
    path: /root/.ssh/authorized_keys
    line: "{{ item }}"
    create: true
    mode: '0600'
  loop: "{{ ssh_authorized_keys }}"
