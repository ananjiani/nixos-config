---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: bifrost
  namespace: bifrost
spec:
  interval: 1h
  chart:
    spec:
      chart: bifrost
      version: ">=1.0.0"
      sourceRef:
        kind: HelmRepository
        name: bifrost
        namespace: flux-system
      interval: 1h
  postRenderers:
    - kustomize:
        patches:
          - patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: bifrost
              spec:
                strategy:
                  type: Recreate
            target:
              kind: Deployment
              name: bifrost
  values:
    image:
      repository: docker.io/maximhq/bifrost
      pullPolicy: IfNotPresent
      tag: "latest"

    service:
      type: ClusterIP
      port: 8080

    storage:
      mode: sqlite
      persistence:
        enabled: true
        storageClass: longhorn
        accessMode: ReadWriteOnce
        size: 10Gi

    bifrost:
      port: 8080
      host: 0.0.0.0
      logLevel: info
      logStyle: json
      encryptionKeySecret:
        name: bifrost-secrets
        key: encryption-key

      client:
        dropExcessRequests: false
        initialPoolSize: 300
        allowedOrigins:
          - "*"
        enableLogging: true
        disableContentLogging: false
        logRetentionDays: 365
        enableGovernance: true
        enforceGovernanceHeader: false
        allowDirectKeys: false
        maxRequestBodySizeMb: 100

      providers:
        deepseek:
          network_config:
            base_url: "https://api.deepseek.com"
            default_request_timeout_in_seconds: 120
          custom_provider_config:
            base_provider_type: openai
          keys:
            - name: "deepseek"
              value: "env.DEEPSEEK_API_KEY"
              weight: 1.0
        zai:
          network_config:
            base_url: "https://api.z.ai/api/coding/paas/v4"
            default_request_timeout_in_seconds: 120
          custom_provider_config:
            base_provider_type: openai
            request_path_overrides:
              chat_completion: "/chat/completions"
              chat_completion_stream: "/chat/completions"
          keys:
            - name: "zai"
              value: "env.ZAI_API_KEY"
              weight: 1.0
              models:
                - "glm-4.7"
        cliproxy:
          network_config:
            base_url: "http://cliproxy.cliproxy.svc:8317"
          custom_provider_config:
            base_provider_type: openai
          keys:
            - name: "cliproxy"
              value: "env.CLIPROXY_API_KEY"
              weight: 1.0
        ollama:
          network_config:
            base_url: "http://ollama.bifrost.svc:11434"
          keys:
            - name: "ollama"
              value: "ollama"
              weight: 1.0

      providerSecrets:
        deepseek:
          existingSecret: bifrost-secrets
          key: deepseek-api-key
          envVar: DEEPSEEK_API_KEY
        zai:
          existingSecret: bifrost-secrets
          key: zai-api-key
          envVar: ZAI_API_KEY
        cliproxy:
          existingSecret: bifrost-secrets
          key: cliproxy-api-key
          envVar: CLIPROXY_API_KEY

      governance:
        authConfig:
          isEnabled: true
          disableAuthOnInference: false
          existingSecret: bifrost-secrets
          usernameKey: admin-username
          passwordKey: admin-password

    env:
      - name: BIFROST_DEFAULT_VK
        valueFrom:
          secretKeyRef:
            name: bifrost-secrets
            key: default-virtual-key

    ingress:
      main:
        enabled: false

    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "1Gi"
        cpu: "500m"
