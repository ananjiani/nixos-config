---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headscale
  namespace: headscale
spec:
  interval: 1h
  chart:
    spec:
      chart: headscale
      version: "0.16.0"
      sourceRef:
        kind: HelmRepository
        name: gabe565
        namespace: flux-system
      interval: 1h
  values:
    # Use official image (chart default)
    # image:
    #   repository: ghcr.io/juanfont/headscale
    #   tag: v0.25.0

    # Configuration via config file (required by official image)
    configMaps:
      config:
        enabled: true
        data:
          config.yaml: |
            server_url: https://ts.dimensiondoor.xyz
            listen_addr: 0.0.0.0:8080
            metrics_listen_addr: 0.0.0.0:9090

            database:
              type: sqlite
              sqlite:
                path: /var/lib/headscale/db.sqlite

            derp:
              server:
                enabled: false
              urls:
                - https://controlplane.tailscale.com/derpmap/default
              auto_update_enabled: true
              update_frequency: 24h

            dns:
              base_domain: tail.dimensiondoor.xyz
              magic_dns: true
              nameservers:
                global:
                  - 192.168.1.53

            prefixes:
              v4: 100.64.0.0/10
              v6: fd7a:115c:a1e0::/48

            disable_check_updates: true

            log:
              level: info

            noise:
              private_key_path: /var/lib/headscale/noise_private.key

            unix_socket: /var/run/headscale/headscale.sock
            unix_socket_permission: "0770"

            policy:
              path: /etc/headscale/acl.json

    persistence:
      data:
        enabled: true
        existingClaim: headscale-data
        mountPath: /var/lib/headscale
      run:
        enabled: true
        type: emptyDir
        mountPath: /var/run/headscale
      config:
        enabled: true
        type: configMap
        name: headscale-config
        mountPath: /etc/headscale
        readOnly: true
      acl:
        enabled: true
        type: configMap
        name: headscale-acl
        subPath: acl.json
        mountPath: /etc/headscale/acl.json
        readOnly: true

    service:
      main:
        ports:
          http:
            port: 8080
          metrics:
            port: 9090

    ingress:
      main:
        enabled: false

    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "200m"

    podAnnotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: "Headscale"
      gethomepage.dev/group: "Infrastructure"
      gethomepage.dev/icon: "headscale.png"
      gethomepage.dev/description: "Tailscale Control Server"
      gethomepage.dev/href: "https://ts.dimensiondoor.xyz"
