---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: headscale
  namespace: headscale
spec:
  interval: 1h
  chart:
    spec:
      chart: headscale
      version: "0.16.0"
      sourceRef:
        kind: HelmRepository
        name: gabe565
        namespace: flux-system
      interval: 1h
  values:
    # Configuration via environment variables
    env:
      HEADSCALE_SERVER_URL: "https://ts.dimensiondoor.xyz"
      HEADSCALE_LISTEN_ADDR: "0.0.0.0:8080"
      HEADSCALE_METRICS_LISTEN_ADDR: "0.0.0.0:9090"
      HEADSCALE_DATABASE_TYPE: "sqlite"
      HEADSCALE_DATABASE_SQLITE_PATH: "/var/lib/headscale/db.sqlite"
      HEADSCALE_DERP_SERVER_ENABLED: "false"
      HEADSCALE_DERP_URLS: "https://controlplane.tailscale.com/derpmap/default"
      HEADSCALE_DNS_BASE_DOMAIN: "tail.dimensiondoor.xyz"
      HEADSCALE_DNS_MAGIC_DNS: "true"
      HEADSCALE_DNS_NAMESERVERS_GLOBAL: "192.168.1.53"
      HEADSCALE_PREFIXES_V4: "100.64.0.0/10"
      HEADSCALE_PREFIXES_V6: "fd7a:115c:a1e0::/48"
      HEADSCALE_DISABLE_CHECK_UPDATES: "true"
      HEADSCALE_LOG_LEVEL: "info"
      HEADSCALE_NOISE_PRIVATE_KEY_PATH: "/var/lib/headscale/noise_private.key"
      HEADSCALE_UNIX_SOCKET: "/var/run/headscale/headscale.sock"
      HEADSCALE_UNIX_SOCKET_PERMISSION: "0770"
      HEADSCALE_POLICY_PATH: "/etc/headscale/acl.json"

    persistence:
      data:
        enabled: true
        existingClaim: headscale-data
        mountPath: /var/lib/headscale
      run:
        enabled: true
        type: emptyDir
        mountPath: /var/run/headscale
      acl:
        enabled: true
        type: configMap
        name: headscale-acl
        mountPath: /etc/headscale
        readOnly: true

    service:
      main:
        ports:
          http:
            port: 8080
          metrics:
            port: 9090

    ingress:
      main:
        enabled: false

    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "200m"

    podAnnotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: "Headscale"
      gethomepage.dev/group: "Infrastructure"
      gethomepage.dev/icon: "headscale.png"
      gethomepage.dev/description: "Tailscale Control Server"
      gethomepage.dev/href: "https://ts.dimensiondoor.xyz"
