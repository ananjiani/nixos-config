---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: open-webui
  namespace: open-webui
spec:
  interval: 1h
  chart:
    spec:
      chart: open-webui
      version: ">=5.0.0"
      sourceRef:
        kind: HelmRepository
        name: open-webui
        namespace: flux-system
      interval: 1h
  valuesFrom:
    - kind: Secret
      name: open-webui-secrets
      valuesKey: secret-key
      targetPath: extraEnvVars.WEBUI_SECRET_KEY
    # Keys must match URLs order: [0]=pipelines (placeholder), [1]=DeepSeek
    - kind: Secret
      name: open-webui-secrets
      valuesKey: deepseek-api-key
      targetPath: openaiApiKeys[1]
    - kind: Secret
      name: open-webui-secrets
      valuesKey: tavily-api-key
      targetPath: extraEnvVars.TAVILY_API_KEY
    - kind: Secret
      name: open-webui-secrets
      valuesKey: oauth_client_secret
      targetPath: extraEnvVars.OAUTH_CLIENT_SECRET
  values:
    # Disable bundled Ollama - we use external
    ollama:
      enabled: false

    # Keep pipelines enabled for future use
    # It will use our openaiBaseApiUrls config below
    pipelines:
      enabled: true

    ollamaUrls:
      - "http://ollama.open-webui.svc:11434"

    # Use the chart's native OpenAI configuration (not extraEnvVars)
    # Note: Pipelines URL is auto-prepended by chart, so DeepSeek is [1]
    openaiBaseApiUrls:
      - "https://api.deepseek.com/v1"

    # Placeholder key for pipelines [0], DeepSeek key set via valuesFrom [1]
    openaiApiKeys:
      - "pipelines-placeholder"

    persistence:
      enabled: true
      existingClaim: open-webui-data

    extraEnvVars:
      ENABLE_OPENAI_API: "true"
      ENABLE_WEB_SEARCH: "true"
      WEB_SEARCH_ENGINE: "tavily"
      WEB_LOADER_ENGINE: "tavily"
      ENABLE_COMMUNITY_SHARING: "false"
      ENABLE_OAUTH_SIGNUP: "true"
      OAUTH_MERGE_ACCOUNTS_BY_EMAIL: "true"
      OAUTH_PROVIDER_NAME: "Authentik"
      OAUTH_CLIENT_ID: "open-webui"
      OPENID_PROVIDER_URL: "https://auth.dimensiondoor.xyz/application/o/open-webui/.well-known/openid-configuration"
      OAUTH_SCOPES: "openid email profile"
      CHROMA_HTTP_HOST: "chromadb.chromadb.svc"
      CHROMA_HTTP_PORT: "8000"

    ingress:
      enabled: false

    resources:
      requests:
        memory: "512Mi"
        cpu: "100m"
      limits:
        memory: "4Gi"
        cpu: "2000m"
