---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: open-webui
  namespace: open-webui
  labels:
    app: open-webui
spec:
  replicas: 1
  strategy:
    type: Recreate # Longhorn PVCs are RWO
  selector:
    matchLabels:
      app: open-webui
  template:
    metadata:
      labels:
        app: open-webui
    spec:
      initContainers:
        - name: ensure-zai-model
          image: ghcr.io/open-webui/open-webui:v0.7.2
          command:
            - /bin/sh
            - -c
          args:
            - |
              python - <<'PY'
              import json
              import sqlite3
              import sys

              db_path = "/app/backend/data/webui.db"
              model_id = "zai/glm-4.7"
              base_model_id = "deepseek/deepseek-chat"
              params = json.dumps({"model": model_id})

              try:
                  con = sqlite3.connect(db_path)
              except sqlite3.Error as exc:
                  print(f"failed to open db: {exc}")
                  sys.exit(1)

              cur = con.cursor()
              row = cur.execute(
                  "select id from model where id = ?",
                  (model_id,),
              ).fetchone()
              if not row:
                  print("model not found, skipping")
                  sys.exit(0)

              cur.execute(
                  "update model set base_model_id = ?, params = ? where id = ?",
                  (base_model_id, params, model_id),
              )
              con.commit()
              print("model updated")
              PY
          volumeMounts:
            - name: data
              mountPath: /app/backend/data
      containers:
        - name: open-webui
          image: ghcr.io/open-webui/open-webui:v0.7.2
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: OLLAMA_BASE_URL
              value: "http://ollama.bifrost.svc:11434"
            - name: WEBUI_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: open-webui-secrets
                  key: secret-key
            # DeepSeek API (OpenAI-compatible)
            # Reset config on start to force re-read of env vars
            # (database was caching stale values from Helm chart experiments)
            - name: RESET_CONFIG_ON_START
              value: "true"
            # Use small model for auxiliary tasks (titles, tags, search queries)
            - name: TASK_MODEL
              value: "ollama/qwen3:0.6b"
            # Default system prompt for all chats
            - name: DEFAULT_SYSTEM_PROMPT
              valueFrom:
                configMapKeyRef:
                  name: open-webui-system-prompt
                  key: system-prompt.md
            - name: ENABLE_OPENAI_API
              value: "true"
            - name: OPENAI_API_BASE_URLS
              value: "http://bifrost.bifrost.svc:8080/v1"
            - name: OPENAI_API_KEYS
              valueFrom:
                secretKeyRef:
                  name: open-webui-secrets
                  key: openai-api-keys
            # Web search via Tavily
            - name: ENABLE_WEB_SEARCH
              value: "true"
            - name: WEB_SEARCH_ENGINE
              value: "tavily"
            - name: WEB_LOADER_ENGINE
              value: "tavily"
            - name: TAVILY_API_KEY
              valueFrom:
                secretKeyRef:
                  name: open-webui-secrets
                  key: tavily-api-key
            # Disable external sharing
            - name: ENABLE_COMMUNITY_SHARING
              value: "false"
            # OAuth via Authentik
            - name: ENABLE_OAUTH_SIGNUP
              value: "true"
            - name: OAUTH_MERGE_ACCOUNTS_BY_EMAIL
              value: "true"
            - name: OAUTH_PROVIDER_NAME
              value: "Authentik"
            - name: OAUTH_CLIENT_ID
              value: "open-webui"
            - name: OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: open-webui-secrets
                  key: oauth_client_secret
            - name: OPENID_PROVIDER_URL
              value: "https://auth.dimensiondoor.xyz/application/o/open-webui/.well-known/openid-configuration"
            - name: OAUTH_SCOPES
              value: "openid email profile"
            # ChromaDB connection for RAG
            - name: CHROMA_HTTP_HOST
              value: "chromadb.chromadb.svc"
            - name: CHROMA_HTTP_PORT
              value: "8000"
            # Use Ollama for GPU-accelerated embeddings
            - name: RAG_EMBEDDING_ENGINE
              value: "ollama"
            - name: RAG_EMBEDDING_MODEL
              value: "ollama/nomic-embed-text"
          volumeMounts:
            - name: data
              mountPath: /app/backend/data
          resources:
            requests:
              memory: "512Mi"
              cpu: "100m"
            limits:
              memory: "4Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: open-webui-data
