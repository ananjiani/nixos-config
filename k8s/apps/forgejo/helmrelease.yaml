---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
  namespace: forgejo
spec:
  interval: 1h
  chart:
    spec:
      chart: forgejo
      version: "15.0.0"
      sourceRef:
        kind: HelmRepository
        name: forgejo
        namespace: flux-system
      interval: 1h
  valuesFrom:
    - kind: Secret
      name: forgejo-secrets
      valuesKey: admin-password
      targetPath: gitea.admin.password
    - kind: Secret
      name: forgejo-secrets
      valuesKey: oauth-client-secret
      targetPath: gitea.oauth[0].secret
  values:
    # Admin user configuration
    gitea:
      admin:
        username: forgejo-admin
        email: admin@dimensiondoor.xyz
        # password injected via valuesFrom

      # Forgejo app.ini configuration
      config:
        APP_NAME: "Forgejo: Dimension Door"

        server:
          DOMAIN: git.dimensiondoor.xyz
          ROOT_URL: https://git.dimensiondoor.xyz
          SSH_DOMAIN: ssh.git.dimensiondoor.xyz
          SSH_PORT: 22

        # Single-user hardening
        repository:
          FORCE_PRIVATE: true
          DEFAULT_PRIVATE: private
          DISABLED_REPO_UNITS: "repo.projects"
          ENABLE_PUSH_CREATE_USER: true
          ENABLE_PUSH_CREATE_ORG: true
          DEFAULT_PUSH_CREATE_PRIVATE: true

        security:
          INSTALL_LOCK: true

        packages:
          ENABLED: true
          STORAGE_TYPE: local
          PATH: /data/packages

        mirror:
          ENABLED: true

        service:
          DISABLE_REGISTRATION: false
          ALLOW_ONLY_EXTERNAL_REGISTRATION: true
          SHOW_REGISTRATION_BUTTON: false

        oauth2_client:
          ENABLE_AUTO_REGISTRATION: true
          USERNAME: nickname
          UPDATE_AVATAR: true
          ACCOUNT_LINKING: auto

        actions:
          ENABLED: false

      # Authentik OAuth2 provider
      oauth:
        - name: authentik
          provider: openidConnect
          key: forgejo
          # secret injected via valuesFrom
          autoDiscoverUrl: https://auth.dimensiondoor.xyz/application/o/forgejo/.well-known/openid-configuration
          scopes: "openid email profile"
          iconUrl: https://auth.dimensiondoor.xyz/static/dist/assets/icons/icon.png
          groupClaimName: groups
          adminGroup: "forgejo-admins"

    # Persistence - Longhorn storage
    persistence:
      enabled: true
      storageClass: longhorn
      size: 10Gi
      accessModes:
        - ReadWriteOnce

    # Use SQLite (default, simpler for homelab)
    # PostgreSQL and Redis not bundled in this chart

    # Disable built-in ingress (using Traefik IngressRoute)
    ingress:
      enabled: false

    # Deployment strategy - Recreate needed for RWO volumes
    strategy:
      type: Recreate

    # Resource limits
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "1Gi"
        cpu: "1000m"

    # NFS volume for container registry packages
    extraVolumes:
      - name: packages-storage
        nfs:
          server: 192.168.1.27 # theoden
          path: /srv/nfs
    extraVolumeMounts:
      - name: packages-storage
        mountPath: /data/packages
        subPath: forgejo/packages

    # Service configuration
    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: LoadBalancer
        port: 22
        annotations:
          metallb.universe.tf/loadBalancerIPs: "192.168.1.55"
