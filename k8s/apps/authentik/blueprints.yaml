---
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
data:
  immich.yaml: |
    # Immich OAuth2/OIDC Configuration
    version: 1
    metadata:
      name: Immich SSO
    entries:
      # OAuth2 Provider for Immich
      - model: authentik_providers_oauth2.oauth2provider
        id: immich-provider
        identifiers:
          name: Immich
        attrs:
          name: Immich
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          client_type: confidential
          client_id: immich
          client_secret: !Env [IMMICH_CLIENT_SECRET, changeme]
          redirect_uris:
            - url: https://immich.dimensiondoor.xyz/auth/login
              matching_mode: strict
            - url: https://immich.dimensiondoor.xyz/user-settings
              matching_mode: strict
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
          sub_mode: user_email

      # Application for Immich
      - model: authentik_core.application
        identifiers:
          slug: immich
        attrs:
          name: Immich
          slug: immich
          provider: !KeyOf immich-provider
          meta_launch_url: https://immich.dimensiondoor.xyz
          meta_icon: https://immich.app/img/immich-logo-stacked-dark.svg
          policy_engine_mode: any

  open-webui.yaml: |
    # Open WebUI OAuth2/OIDC Configuration
    version: 1
    metadata:
      name: Open WebUI SSO
    entries:
      # OAuth2 Provider for Open WebUI
      - model: authentik_providers_oauth2.oauth2provider
        id: open-webui-provider
        identifiers:
          name: Open WebUI
        attrs:
          name: Open WebUI
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          client_type: confidential
          client_id: open-webui
          client_secret: !Env [OPENWEBUI_CLIENT_SECRET, changeme]
          redirect_uris:
            - url: https://ai.dimensiondoor.xyz/oauth/oidc/callback
              matching_mode: strict
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
          sub_mode: user_email

      # Application for Open WebUI
      - model: authentik_core.application
        identifiers:
          slug: open-webui
        attrs:
          name: Open WebUI
          slug: open-webui
          provider: !KeyOf open-webui-provider
          meta_launch_url: https://ai.dimensiondoor.xyz
          meta_icon: https://docs.openwebui.com/img/logo.png
          policy_engine_mode: any

  forgejo.yaml: |
    # Forgejo OAuth2/OIDC Configuration
    version: 1
    metadata:
      name: Forgejo SSO
    entries:
      # OAuth2 Provider for Forgejo
      - model: authentik_providers_oauth2.oauth2provider
        id: forgejo-provider
        identifiers:
          name: Forgejo
        attrs:
          name: Forgejo
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          client_type: confidential
          client_id: forgejo
          client_secret: !Env [FORGEJO_CLIENT_SECRET, changeme]
          redirect_uris:
            - url: https://git.dimensiondoor.xyz/user/oauth2/authentik/callback
              matching_mode: strict
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
          sub_mode: user_username

      # Application for Forgejo
      - model: authentik_core.application
        identifiers:
          slug: forgejo
        attrs:
          name: Forgejo
          slug: forgejo
          provider: !KeyOf forgejo-provider
          meta_launch_url: https://git.dimensiondoor.xyz
          meta_icon: https://forgejo.org/favicon.ico
          policy_engine_mode: any
