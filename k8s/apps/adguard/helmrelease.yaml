---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: adguard-home
  namespace: adguard
spec:
  interval: 1h
  chart:
    spec:
      chart: adguard-home
      version: ">=0.19.0"
      sourceRef:
        kind: HelmRepository
        name: rm3l
        namespace: flux-system
      interval: 1h
  values:
    image:
      repository: adguard/adguardhome
      tag: latest

    persistence:
      enabled: true
      existingClaim: adguard-data

    # Sync config from ConfigMap on every startup (truly declarative)
    initContainers:
      - name: sync-config
        image: busybox:latest
        command:
          - sh
          - -c
          - |
            echo "Syncing AdGuard config from ConfigMap..."
            cp /config-source/AdGuardHome.yaml /opt/adguardhome/conf/AdGuardHome.yaml
            echo "Config synced successfully"
        volumeMounts:
          - name: data
            mountPath: /opt/adguardhome/conf
          - name: config-source
            mountPath: /config-source

    extraVolumes:
      - name: config-source
        configMap:
          name: adguard-config

    extraVolumeMounts:
      - name: config-source
        mountPath: /config-source

    # Services - LoadBalancer with MetalLB
    services:
      dns:
        type: LoadBalancer
        externalTrafficPolicy: Local
        annotations:
          metallb.universe.tf/loadBalancerIPs: "192.168.1.53"
        tcp:
          port: 53
        udp:
          port: 53

      http:
        type: LoadBalancer
        externalTrafficPolicy: Local
        annotations:
          metallb.universe.tf/loadBalancerIPs: "192.168.1.54"

    ingress:
      enabled: false

    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

    podAnnotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: "AdGuard Home"
      gethomepage.dev/group: "Infrastructure"
      gethomepage.dev/icon: "adguard-home.png"
      gethomepage.dev/description: "DNS & Ad Blocking"
      gethomepage.dev/href: "http://192.168.1.54"

    # Config is managed declaratively via config.yaml ConfigMap
    # The init container syncs it on every pod startup
